name: Update Claude Code Documentation

on:
  schedule:
    # Run every 3 hours (at 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC)
    - cron: '0 */3 * * *'
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: update-docs
  cancel-in-progress: true

permissions:
  contents: write
  issues: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt

    - name: Sentinel check
      id: sentinel
      run: |
        SENTINEL_DIR=".github/sentinels"
        mkdir -p "$SENTINEL_DIR"

        # Fetch and hash llms.txt
        LLMS_HASH=$(curl -sf "https://code.claude.com/docs/llms.txt" | sha256sum | cut -d' ' -f1 || echo "fetch_failed")
        DOCS_MAP_HASH=$(curl -sf "https://code.claude.com/docs/en/claude_code_docs_map.md" | sha256sum | cut -d' ' -f1 || echo "fetch_failed")

        # Read stored sentinels
        OLD_LLMS=$(cat "$SENTINEL_DIR/llms_txt.sha256" 2>/dev/null || echo "none")
        OLD_DOCS_MAP=$(cat "$SENTINEL_DIR/docs_map.sha256" 2>/dev/null || echo "none")

        if [[ "$LLMS_HASH" != "fetch_failed" && "$DOCS_MAP_HASH" != "fetch_failed" &&
              "$LLMS_HASH" == "$OLD_LLMS" && "$DOCS_MAP_HASH" == "$OLD_DOCS_MAP" ]]; then
          echo "skip_fetch=true" >> "$GITHUB_OUTPUT"
          echo "Sentinels unchanged -- skipping full fetch"
        else
          # Store new hashes as outputs; sentinel files updated only after successful commit
          echo "skip_fetch=false" >> "$GITHUB_OUTPUT"
          echo "llms_hash=$LLMS_HASH" >> "$GITHUB_OUTPUT"
          echo "docs_map_hash=$DOCS_MAP_HASH" >> "$GITHUB_OUTPUT"
          echo "Sentinels changed or fetch failed -- proceeding with full fetch"
        fi

    - name: Fetch latest documentation
      if: steps.sentinel.outputs.skip_fetch != 'true'
      id: fetch-docs
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
      run: |
        python scripts/fetch_claude_docs.py || echo "fetch_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Check for changes
      id: verify-changed-files
      run: |
        git diff --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

    - name: Generate recent changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        GITHUB_REPO="${GITHUB_REPOSITORY:-doublefx/claude-code-docs}"
        OUTPUT="plugin/docs/recent_changes.md"

        echo "# Recent Documentation Changes" > "$OUTPUT"
        echo "" >> "$OUTPUT"
        echo "> Auto-generated by CI. Shows documentation updates from the last 30 days." >> "$OUTPUT"
        echo "" >> "$OUTPUT"

        git log --format="%H|%ai|%s" -20 --since="30 days ago" -- plugin/docs/*.md 2>/dev/null | while IFS='|' read -r hash date msg; do
          SHORT_DATE=$(echo "$date" | cut -d' ' -f1)
          SHORT_HASH=$(echo "$hash" | cut -c1-7)

          echo "## $SHORT_DATE ($SHORT_HASH)" >> "$OUTPUT"
          echo "" >> "$OUTPUT"

          git diff-tree --no-commit-id --name-only -r "$hash" -- plugin/docs/*.md 2>/dev/null | while read -r file; do
            BASENAME=$(basename "$file" .md)
            echo "- **$BASENAME** ([view](https://github.com/$GITHUB_REPO/commit/$hash))" >> "$OUTPUT"
          done

          echo "" >> "$OUTPUT"
        done

        echo "---" >> "$OUTPUT"
        echo "" >> "$OUTPUT"
        echo "Full history: https://github.com/$GITHUB_REPO/commits/main/plugin/docs" >> "$OUTPUT"

    - name: Bump plugin version
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        PLUGIN_JSON="plugin/.claude-plugin/plugin.json"
        CURRENT_VERSION=$(jq -r '.version' "$PLUGIN_JSON")
        TODAY=$(date +'%Y.%-m.%-d')

        # Parse current version
        CURRENT_DATE_PREFIX=$(echo "$CURRENT_VERSION" | rev | cut -d'.' -f2- | rev)
        CURRENT_N=$(echo "$CURRENT_VERSION" | rev | cut -d'.' -f1 | rev)

        if [[ "$CURRENT_DATE_PREFIX" == "$TODAY" ]]; then
          NEW_N=$((CURRENT_N + 1))
        else
          NEW_N=1
        fi

        NEW_VERSION="${TODAY}.${NEW_N}"
        TMP=$(mktemp) && jq --arg v "$NEW_VERSION" '.version = $v' "$PLUGIN_JSON" > "$TMP" && mv "$TMP" "$PLUGIN_JSON"
        echo "Bumped version: $CURRENT_VERSION -> $NEW_VERSION"

    - name: Generate commit message
      if: steps.verify-changed-files.outputs.changed == 'true'
      id: commit-msg
      run: |
        # Stage all expected files
        git add plugin/docs/*.md plugin/docs/docs_manifest.json plugin/.claude-plugin/plugin.json plugin/docs/recent_changes.md .github/sentinels/

        # Get list of changed files
        CHANGED_FILES=$(git diff --name-status --cached | grep "^M" | cut -f2 | grep -E "\.md$" | sed 's|plugin/docs/||' | paste -sd ", " -)
        ADDED_FILES=$(git diff --name-status --cached | grep "^A" | cut -f2 | grep -E "\.md$" | sed 's|plugin/docs/||' | paste -sd ", " -)
        DELETED_FILES=$(git diff --name-status --cached | grep "^D" | cut -f2 | grep -E "\.md$" | sed 's|plugin/docs/||' | paste -sd ", " -)

        # Build commit message
        COMMIT_MSG="Update Claude Code docs - $(date +'%Y-%m-%d')"

        if [ -n "$CHANGED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Updated: $CHANGED_FILES"
        fi

        if [ -n "$ADDED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Added: $ADDED_FILES"
        fi

        if [ -n "$DELETED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Removed: $DELETED_FILES"
        fi

        echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

    - name: Commit and push if changed
      if: steps.verify-changed-files.outputs.changed == 'true'
      env:
        COMMIT_MSG: ${{ steps.commit-msg.outputs.message }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # Files already staged in previous step
        git commit -m "$COMMIT_MSG"
        git push

    - name: Update sentinels after successful commit
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        SENTINEL_DIR=".github/sentinels"
        LLMS_HASH="${{ steps.sentinel.outputs.llms_hash }}"
        DOCS_MAP_HASH="${{ steps.sentinel.outputs.docs_map_hash }}"
        [[ -n "$LLMS_HASH" && "$LLMS_HASH" != "fetch_failed" ]] && echo "$LLMS_HASH" > "$SENTINEL_DIR/llms_txt.sha256"
        [[ -n "$DOCS_MAP_HASH" && "$DOCS_MAP_HASH" != "fetch_failed" ]] && echo "$DOCS_MAP_HASH" > "$SENTINEL_DIR/docs_map.sha256"
        git add "$SENTINEL_DIR/"
        git commit -m "chore: update sentinel hashes" || true
        git push

    - name: Create issue on failure
      if: steps.fetch-docs.outputs.fetch_failed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          // Check for existing open issue to prevent duplicates
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'automation',
          });
          const duplicate = existingIssues.data.find(
            issue => issue.title.startsWith('Documentation update failed')
          );
          if (duplicate) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: duplicate.number,
              body: `Documentation update failed again on ${date}.\n\nSee [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Documentation update failed - ${date}`,
              body: `The automated documentation update failed on ${date}.\n\nPlease check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['bug', 'automation']
            });
          }
